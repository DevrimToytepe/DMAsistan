<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DMAsistan ‚Äî ≈ûifre Sƒ±fƒ±rla</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:#0A0E1A; --bg-2:#0F1428; --purple:#7C3AED; --purple-light:#9B5CF6;
      --pink:#F43F75; --white:#FFFFFF; --gray:#A1A1AA;
      --glass:rgba(255,255,255,0.04); --glass-border:rgba(255,255,255,0.08);
      --gradient:linear-gradient(135deg,var(--purple),var(--pink));
      --transition:all 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--white);min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;}
    h1,h2,h3{font-family:'Sora',sans-serif;}
    a{text-decoration:none;color:inherit;}
    .blob{position:fixed;border-radius:50%;filter:blur(120px);opacity:0.18;pointer-events:none;z-index:0;animation:blobFloat 12s ease-in-out infinite alternate;}
    .blob-1{width:500px;height:500px;background:var(--pink);top:-150px;right:-150px;animation-duration:13s;}
    .blob-2{width:400px;height:400px;background:var(--purple);bottom:0;left:-100px;animation-duration:10s;}
    @keyframes blobFloat{from{transform:translate(0,0) scale(1);}to{transform:translate(25px,20px) scale(1.07);}}
    .navbar{position:relative;z-index:10;padding:20px 32px;display:flex;align-items:center;justify-content:space-between;}
    .logo{display:flex;align-items:center;gap:8px;font-family:'Sora',sans-serif;font-weight:700;font-size:1.25rem;}
    .nav-right{font-size:0.9rem;color:var(--gray);}
    .nav-right a{color:var(--purple-light);font-weight:500;}
    .nav-right a:hover{color:var(--white);}
    .auth-wrapper{flex:1;display:flex;align-items:center;justify-content:center;padding:32px 20px 60px;position:relative;z-index:1;}
    .card{width:100%;max-width:460px;background:var(--bg-2);border:1px solid var(--glass-border);border-radius:28px;padding:48px 44px;box-shadow:0 0 80px rgba(124,58,237,0.12),0 32px 64px rgba(0,0,0,0.4);animation:fadeUp 0.55s cubic-bezier(0.4,0,0.2,1) both;}
    @keyframes fadeUp{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:translateY(0);}}
    .card-logo{text-align:center;margin-bottom:28px;}
    .logo-mark{display:inline-flex;align-items:center;justify-content:center;width:56px;height:56px;border-radius:18px;background:linear-gradient(135deg,rgba(124,58,237,0.3),rgba(244,63,117,0.2));border:1px solid rgba(124,58,237,0.4);font-size:1.6rem;margin-bottom:12px;}
    .card-logo h2{font-size:1.7rem;font-weight:800;margin-bottom:6px;}
    .card-logo p{color:var(--gray);font-size:0.88rem;line-height:1.5;}
    .gradient-text{background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .form-group{margin-bottom:16px;}
    .form-label{font-size:0.82rem;font-weight:500;color:rgba(255,255,255,0.7);margin-bottom:7px;display:block;}
    .input-wrap{position:relative;}
    .field-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:var(--gray);pointer-events:none;}
    .form-input{width:100%;padding:13px 14px 13px 40px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:var(--white);font-size:0.92rem;font-family:'Inter',sans-serif;transition:var(--transition);outline:none;}
    .form-input::placeholder{color:rgba(255,255,255,0.3);}
    .form-input:focus{border-color:var(--purple);background:rgba(124,58,237,0.08);box-shadow:0 0 0 3px rgba(124,58,237,0.15);}
    .btn-submit{width:100%;padding:14px;background:var(--gradient);border:none;border-radius:12px;color:var(--white);font-size:1rem;font-weight:700;font-family:'Sora',sans-serif;cursor:pointer;transition:var(--transition);margin-top:4px;}
    .btn-submit:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(124,58,237,0.4);}
    .btn-submit:disabled{opacity:0.6;pointer-events:none;}
    .btn-spinner{display:none;width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.7s linear infinite;margin:0 auto;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .msg-box{border-radius:10px;padding:12px 16px;font-size:0.88rem;margin-bottom:16px;display:none;}
    .msg-error{background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.4);color:#f43f5e;}
    .msg-success{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.4);color:#22c55e;}
    .back-link{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:20px;font-size:0.85rem;color:var(--gray);}
    .back-link a{color:var(--purple-light);font-weight:500;}
    .back-link a:hover{color:var(--white);}
    /* YENƒ∞ ≈ûƒ∞FRE FORMU (reset token ile) */
    #newPasswordForm{display:none;}
    .pass-toggle{position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--gray);cursor:pointer;display:flex;transition:color 0.2s;}
    .pass-toggle:hover{color:var(--white);}
    .pass-toggle svg{width:17px;height:17px;}
    .strength-wrap{margin-top:8px;display:none;}
    .strength-bar{height:4px;background:rgba(255,255,255,0.08);border-radius:2px;overflow:hidden;}
    .strength-fill{height:100%;width:0;border-radius:2px;transition:all 0.3s;}
    @media(max-width:480px){.card{padding:32px 20px;}}
  </style>
</head>
<body>
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>

  <nav class="navbar">
    <a href="index.html" class="logo"><span>‚ö°</span> DMAsistan</a>
    <div class="nav-right">Hesabƒ±n var mƒ±? <a href="giris.html">Giri≈ü Yap</a></div>
  </nav>

  <div class="auth-wrapper">
    <div class="card">
      <div class="card-logo">
        <div class="logo-mark">üîê</div>
        <h2>≈ûifre <span class="gradient-text">Sƒ±fƒ±rla</span></h2>
        <p id="cardDesc">E-posta adresini gir, sana sƒ±fƒ±rlama linki g√∂nderelim.</p>
      </div>

      <!-- HATA / BA≈ûARI -->
      <div class="msg-box msg-error" id="errorBox"></div>
      <div class="msg-box msg-success" id="successBox"></div>

      <!-- E-POSTA FORMU (varsayƒ±lan) -->
      <form id="emailForm" novalidate>
        <div class="form-group">
          <label class="form-label">E-posta Adresi</label>
          <div class="input-wrap">
            <svg class="field-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            <input class="form-input" type="email" id="emailInput" placeholder="sen@sirket.com" autocomplete="email" />
          </div>
        </div>
        <button type="submit" class="btn-submit" id="sendBtn">
          <span class="btn-text">üì® Sƒ±fƒ±rlama Linki G√∂nder</span>
          <span class="btn-spinner"></span>
        </button>
      </form>

      <!-- YENƒ∞ ≈ûƒ∞FRE FORMU (token ile d√∂nenler i√ßin) -->
      <form id="newPasswordForm" novalidate>
        <div class="form-group">
          <label class="form-label">Yeni ≈ûifre</label>
          <div class="input-wrap">
            <svg class="field-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <input class="form-input" type="password" id="newPassInput" placeholder="En az 8 karakter" />
            <button type="button" class="pass-toggle" id="toggleNew">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>
          <div class="strength-wrap" id="strengthWrap">
            <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Yeni ≈ûifre (Tekrar)</label>
          <div class="input-wrap">
            <svg class="field-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <input class="form-input" type="password" id="confirmPassInput" placeholder="≈ûifreyi tekrar girin" />
          </div>
        </div>
        <button type="submit" class="btn-submit" id="updateBtn">
          <span class="btn-text">üîê ≈ûifremi G√ºncelle</span>
          <span class="btn-spinner"></span>
        </button>
      </form>

      <div class="back-link">‚Üê <a href="giris.html">Giri≈ü sayfasƒ±na d√∂n</a></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js'

    const errorBox   = document.getElementById('errorBox')
    const successBox = document.getElementById('successBox')

    function showError(msg) {
      errorBox.textContent = '‚ö†Ô∏è ' + msg
      errorBox.style.display = 'block'
      successBox.style.display = 'none'
    }
    function showSuccess(msg) {
      successBox.textContent = msg
      successBox.style.display = 'block'
      errorBox.style.display = 'none'
    }
    function setLoading(btnId, spinnerId, active) {
      const btn = document.getElementById(btnId)
      const sp  = document.getElementById(spinnerId)
      if (!btn) return
      btn.disabled = active
      btn.querySelector('.btn-text').style.display = active ? 'none' : 'inline'
      btn.querySelector('.btn-spinner').style.display = active ? 'inline-block' : 'none'
    }

    // ‚îÄ‚îÄ Token kontrol√º ‚Äî URL'de recovery token var mƒ±? ‚îÄ‚îÄ
    const hash = window.location.hash
    const params = new URLSearchParams(hash.replace('#', '?'))
    const accessToken = params.get('access_token')
    const type = params.get('type')

    if (type === 'recovery' && accessToken) {
      // Token'ƒ± Supabase'e set et
      await supabase.auth.setSession({ access_token: accessToken, refresh_token: params.get('refresh_token') || '' })
      // Yeni ≈üifre formunu g√∂ster
      document.getElementById('emailForm').style.display = 'none'
      document.getElementById('newPasswordForm').style.display = 'block'
      document.getElementById('cardDesc').textContent = 'Yeni ≈üifreni belirle.'
      window.history.replaceState({}, '', window.location.pathname)
    }

    // ‚îÄ‚îÄ E-posta g√∂nder ‚îÄ‚îÄ
    document.getElementById('emailForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const email = document.getElementById('emailInput').value.trim()
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        return showError('Ge√ßerli bir e-posta adresi girin.')
      }
      setLoading('sendBtn', 'sendBtn', true)
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/sifre-sifirla.html`
      })
      setLoading('sendBtn', 'sendBtn', false)
      if (error) return showError('G√∂nderim ba≈üarƒ±sƒ±z: ' + error.message)
      showSuccess('üìß Sƒ±fƒ±rlama linki e-posta adresinize g√∂nderildi! Gelen kutunuzu kontrol edin.')
      document.getElementById('emailForm').style.opacity = '0.4'
      document.getElementById('emailForm').style.pointerEvents = 'none'
    })

    // ‚îÄ‚îÄ Yeni ≈üifre g√ºncelle ‚îÄ‚îÄ
    document.getElementById('newPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault()
      const pass    = document.getElementById('newPassInput').value
      const confirm = document.getElementById('confirmPassInput').value
      if (!pass || pass.length < 8) return showError('≈ûifre en az 8 karakter olmalƒ±.')
      if (pass !== confirm) return showError('≈ûifreler e≈üle≈ümiyor.')
      setLoading('updateBtn', 'updateBtn', true)
      const { error } = await supabase.auth.updateUser({ password: pass })
      setLoading('updateBtn', 'updateBtn', false)
      if (error) return showError('G√ºncelleme ba≈üarƒ±sƒ±z: ' + error.message)
      showSuccess('‚úÖ ≈ûifreniz g√ºncellendi! Y√∂nlendiriliyorsunuz...')
      setTimeout(() => { window.location.href = '/DMAsistan/giris.html' }, 1800)
    })

    // ‚îÄ‚îÄ ≈ûifre g√∂ster/gizle ‚îÄ‚îÄ
    document.getElementById('toggleNew')?.addEventListener('click', () => {
      const inp = document.getElementById('newPassInput')
      inp.type = inp.type === 'password' ? 'text' : 'password'
    })

    // ‚îÄ‚îÄ ≈ûifre g√º√ß g√∂stergesi ‚îÄ‚îÄ
    document.getElementById('newPassInput')?.addEventListener('input', function() {
      const val = this.value
      document.getElementById('strengthWrap').style.display = val ? 'block' : 'none'
      let score = 0
      if (val.length >= 8) score++
      if (/[A-Z]/.test(val)) score++
      if (/[0-9]/.test(val)) score++
      if (/[^A-Za-z0-9]/.test(val)) score++
      const fill = document.getElementById('strengthFill')
      const colors = ['#ef4444','#f97316','#eab308','#22c55e']
      fill.style.width = (score * 25) + '%'
      fill.style.background = colors[score - 1] || 'transparent'
    })
  </script>
</body>
</html>
