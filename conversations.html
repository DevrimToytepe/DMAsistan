<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="description" content="DMAsistan Konu≈ümalar Paneli" />
  <title>Konu≈ümalar ‚Äî DMAsistan</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet" />
  <style>
    :root {
      --bg: #0A0E1A;
      --bg-2: #0F1428;
      --purple: #7C3AED;
      --purple-light: #9B5CF6;
      --pink: #F43F75;
      --white: #FFFFFF;
      --gray: #A1A1AA;
      --glass: rgba(255, 255, 255, 0.04);
      --glass-border: rgba(255, 255, 255, 0.08);
      --gradient: linear-gradient(135deg, #7C3AED, #F43F75);
      --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      --sidebar-w: 248px;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--white);
      min-height: 100vh;
      display: flex;
      overflow-x: hidden;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    .blob {
      position: fixed;
      border-radius: 50%;
      filter: blur(140px);
      opacity: 0.07;
      pointer-events: none;
      z-index: 0;
    }

    .blob-1 {
      width: 700px;
      height: 700px;
      background: var(--purple);
      top: -300px;
      left: -100px;
    }

    .blob-2 {
      width: 500px;
      height: 500px;
      background: var(--pink);
      bottom: -200px;
      right: -50px;
    }

    .sidebar {
      width: var(--sidebar-w);
      flex-shrink: 0;
      background: var(--bg-2);
      border-right: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 100;
      padding: 0 12px 20px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Sora', sans-serif;
      font-weight: 800;
      font-size: 1.3rem;
      padding: 20px 12px;
      margin-bottom: 8px;
      border-bottom: 1px solid var(--glass-border);
    }

    .nav-section {
      font-family: 'Sora', sans-serif;
      font-size: 0.67rem;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.22);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 14px 12px 6px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 1px;
      font-size: 0.88rem;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
    }

    .nav-item:hover {
      background: var(--glass);
      color: var(--white);
    }

    .nav-item.active {
      background: rgba(124, 58, 237, 0.14);
      color: var(--white);
    }

    .nav-item .nav-icon {
      font-size: 1rem;
      width: 22px;
      text-align: center;
      flex-shrink: 0;
    }

    .nav-badge {
      margin-left: auto;
      background: var(--gradient);
      border-radius: 100px;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 7px;
      color: white;
    }

    .sidebar-divider {
      height: 1px;
      background: var(--glass-border);
      margin: 10px 0;
    }

    .sidebar-bottom {
      margin-top: auto;
    }

    .user-card {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 11px 12px;
      text-decoration: none;
    }

    .user-avatar-sq {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .user-info .name {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .user-info .plan {
      font-size: 0.72rem;
      color: var(--gray);
      margin-top: 1px;
    }

    .logout-btn {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--gray);
      font-size: 1.1rem;
      cursor: pointer;
      padding: 4px;
      transition: color 0.2s;
    }

    .logout-btn:hover {
      color: var(--pink);
    }

    .main {
      margin-left: var(--sidebar-w);
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }

    .topbar {
      height: 68px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      border-bottom: 1px solid var(--glass-border);
      background: rgba(10, 14, 26, 0.85);
      backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .topbar-title {
      font-family: 'Sora', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .topbar-sub {
      font-size: 0.78rem;
      color: var(--gray);
      margin-top: 1px;
    }

    /* CONVERSATIONS LAYOUT */
    .conv-layout {
      display: grid;
      grid-template-columns: 340px 1fr;
      flex: 1;
      height: calc(100vh - 68px);
    }

    /* LIST */
    .conv-list-wrap {
      border-right: 1px solid var(--glass-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .conv-search {
      padding: 14px 16px;
      border-bottom: 1px solid var(--glass-border);
    }

    .search-input {
      width: 100%;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: var(--white);
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      outline: none;
      transition: var(--transition);
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.25);
    }

    .search-input:focus {
      border-color: var(--purple);
    }

    .conv-filters {
      display: flex;
      gap: 6px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--glass-border);
    }

    .filter-btn {
      padding: 5px 12px;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--glass-border);
      background: var(--glass);
      color: var(--gray);
      transition: var(--transition);
    }

    .filter-btn.active {
      background: rgba(124, 58, 237, 0.15);
      border-color: rgba(124, 58, 237, 0.35);
      color: var(--white);
    }

    .conv-list {
      flex: 1;
      overflow-y: auto;
    }

    .conv-list::-webkit-scrollbar {
      width: 4px;
    }

    .conv-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .conv-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .conv-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      cursor: pointer;
      transition: background 0.15s;
    }

    .conv-item:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .conv-item.active {
      background: rgba(124, 58, 237, 0.1);
    }

    .conv-avatar {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      flex-shrink: 0;
      position: relative;
    }

    .conv-platform {
      position: absolute;
      bottom: -3px;
      right: -3px;
      font-size: 0.7rem;
      background: var(--bg-2);
      border-radius: 50%;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .conv-info {
      flex: 1;
      min-width: 0;
    }

    .conv-name {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .conv-time {
      font-size: 0.7rem;
      color: var(--gray);
      flex-shrink: 0;
    }

    .conv-preview {
      font-size: 0.77rem;
      color: var(--gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .unread-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--purple);
      flex-shrink: 0;
    }

    /* CHAT */
    .conv-chat {
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.01);
    }

    .chat-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .chat-header-avatar {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    .chat-header-name {
      font-family: 'Sora', sans-serif;
      font-weight: 700;
      font-size: 0.95rem;
    }

    .chat-header-sub {
      font-size: 0.75rem;
      color: var(--gray);
    }

    .chat-header-actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    .chat-action-btn {
      padding: 7px 14px;
      border-radius: 8px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--gray);
      font-size: 0.78rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .chat-action-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--white);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-messages::-webkit-scrollbar {
      width: 4px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .msg-bubble {
      max-width: 72%;
      padding: 11px 15px;
      border-radius: 16px;
      font-size: 0.87rem;
      line-height: 1.55;
    }

    .msg-bubble.inbound {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--glass-border);
      align-self: flex-start;
      border-radius: 4px 16px 16px 16px;
    }

    .msg-bubble.outbound {
      background: rgba(124, 58, 237, 0.2);
      border: 1px solid rgba(124, 58, 237, 0.3);
      align-self: flex-end;
      border-radius: 16px 4px 16px 16px;
    }

    .msg-bubble.ai {
      background: rgba(244, 63, 117, 0.1);
      border: 1px solid rgba(244, 63, 117, 0.2);
      align-self: flex-end;
      border-radius: 16px 4px 16px 16px;
    }

    .msg-meta {
      font-size: 0.68rem;
      color: rgba(255, 255, 255, 0.35);
      margin-top: 4px;
    }

    .msg-ai-tag {
      font-size: 0.65rem;
      color: var(--pink);
      font-weight: 700;
      margin-bottom: 3px;
    }

    .chat-input-wrap {
      padding: 16px 24px;
      border-top: 1px solid var(--glass-border);
    }

    .chat-input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    .chat-textarea {
      flex: 1;
      padding: 11px 14px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--white);
      font-family: 'Inter', sans-serif;
      font-size: 0.88rem;
      resize: none;
      outline: none;
      min-height: 44px;
      max-height: 120px;
      transition: border-color 0.2s;
    }

    .chat-textarea:focus {
      border-color: var(--purple);
    }

    .chat-textarea::placeholder {
      color: rgba(255, 255, 255, 0.25);
    }

    .chat-send-btn {
      padding: 11px 18px;
      background: var(--gradient);
      border: none;
      border-radius: 12px;
      color: white;
      font-family: 'Sora', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .chat-send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(124, 58, 237, 0.35);
    }

    /* EMPTY STATE */
    .empty-conv {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      text-align: center;
      color: var(--gray);
    }

    .empty-conv .icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .empty-conv h3 {
      font-family: 'Sora', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 6px;
    }

    @media(max-width:768px) {
      .sidebar {
        display: none;
      }

      .main {
        margin-left: 0;
      }

      .conv-layout {
        grid-template-columns: 1fr;
      }

      .conv-chat {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <aside class="sidebar">
    <div class="sidebar-logo"><span>‚ö°</span> DMAsistan</div>
    <div class="nav-section">Ana Men√º</div>
    <a class="nav-item" href="dashboard.html"><span class="nav-icon">üìä</span> Dashboard</a>
    <a class="nav-item active" href="conversations.html"><span class="nav-icon">üí¨</span> Konu≈ümalar <span
        class="nav-badge" id="unreadBadge">0</span></a>
    <a class="nav-item" href="automation.html"><span class="nav-icon">ü§ñ</span> AI & Otomasyon</a>
    <a class="nav-item" href="contacts.html"><span class="nav-icon">üë•</span> Ki≈üiler</a>
    <a class="nav-item" href="analytics.html"><span class="nav-icon">üìà</span> Analitik</a>
    <div class="sidebar-divider"></div>
    <div class="nav-section">Ayarlar</div>
    <a class="nav-item" href="integrations.html"><span class="nav-icon">üîó</span> Entegrasyonlar</a>
    <a class="nav-item" href="settings.html"><span class="nav-icon">‚öôÔ∏è</span> Ayarlar</a>
    <a class="nav-item" href="billing.html"><span class="nav-icon">üí≥</span> Faturalama</a>
    <div class="sidebar-divider"></div>
    <div class="sidebar-bottom">
      <a class="user-card" href="settings.html">
        <div class="user-avatar-sq" id="sidebarAvatar">?</div>
        <div class="user-info">
          <div class="name" id="sidebarName">Y√ºkleniyor...</div>
          <div class="plan">üÜì √úcretsiz Plan</div>
        </div>
        <button class="logout-btn" id="logoutBtn">‚èª</button>
      </a>
    </div>
  </aside>

  <div class="main">
    <div class="topbar">
      <div>
        <div class="topbar-title">Konu≈ümalar</div>
        <div class="topbar-sub" id="convCount">Y√ºkleniyor...</div>
      </div>
    </div>
    <div class="conv-layout">
      <!-- LIST -->
      <div class="conv-list-wrap">
        <div class="conv-search">
          <input class="search-input" type="text" placeholder="üîç Konu≈üma ara..." id="searchInput" />
        </div>
        <div class="conv-filters">
          <button class="filter-btn active" onclick="filterConvs('all', this)">T√ºm√º</button>
          <button class="filter-btn" onclick="filterConvs('open', this)">A√ßƒ±k</button>
          <button class="filter-btn" onclick="filterConvs('pending', this)">Bekleyen</button>
          <button class="filter-btn" onclick="filterConvs('closed', this)">Kapalƒ±</button>
        </div>
        <div class="conv-list" id="convList">
          <div style="padding:40px 20px;text-align:center;color:var(--gray);">
            <div style="font-size:1.8rem;margin-bottom:8px;">‚è≥</div>
            Y√ºkleniyor...
          </div>
        </div>
      </div>
      <!-- CHAT -->
      <div class="conv-chat" id="convChat">
        <div class="empty-conv">
          <div class="icon">üí¨</div>
          <h3>Bir konu≈üma se√ßin</h3>
          <p style="font-size:0.82rem;">Soldan bir konu≈ümaya tƒ±klayƒ±n</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js'

    let allConvs = []
    let activeConvId = null

      ; (async () => {
        const { data: { session } } = await supabase.auth.getSession()
        if (!session) { window.location.replace('giris.html'); return }
        window._supabase = supabase
        const uid = session.user.id
        const name = session.user.user_metadata?.full_name || session.user.email.split('@')[0]
        document.getElementById('sidebarAvatar').textContent = name.charAt(0).toUpperCase()
        document.getElementById('sidebarName').textContent = name

        // Konu≈ümalarƒ± y√ºkle
        await loadConversations(uid)

        // Realtime subscribe
        supabase.channel('conversations').on('postgres_changes', { event: '*', schema: 'public', table: 'conversations', filter: `user_id=eq.${uid}` }, () => loadConversations(uid)).subscribe()

        supabase.auth.onAuthStateChange(e => { if (e === 'SIGNED_OUT') window.location.replace('giris.html') })
      })()

    async function loadConversations(uid) {
      const { data } = await supabase.from('conversations').select('*').eq('user_id', uid).order('last_message_at', { ascending: false })
      allConvs = data || []
      renderConvList(allConvs)
      const total = allConvs.length
      const unread = allConvs.reduce((s, c) => s + (c.unread_count || 0), 0)
      document.getElementById('convCount').textContent = `${total} konu≈üma${unread > 0 ? ` ¬∑ ${unread} okunmamƒ±≈ü` : ''}`
      document.getElementById('unreadBadge').textContent = unread
    }

    const PLATFORM_ICONS = { instagram: 'üì∏', whatsapp: 'üí¨', facebook: 'üëç', tiktok: 'üéµ' }

    // XSS korumasƒ± ‚Äî t√ºm kullanƒ±cƒ± verisini escape et
    function escapeHtml(str) {
      if (!str) return ''
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;')
    }

    function renderConvList(convs) {
      const list = document.getElementById('convList')
      if (!convs.length) {
        list.innerHTML = `<div style="padding:40px 20px;text-align:center;color:var(--gray);font-size:0.85rem;"><div style="font-size:2rem;margin-bottom:8px;">üí¨</div>Hen√ºz konu≈üma yok<br><small>Platform baƒülayƒ±n ve mesajlar burada g√∂r√ºns√ºn</small></div>`
        return
      }
      list.innerHTML = convs.map(c => `
        <div class="conv-item ${c.id === activeConvId ? 'active' : ''}" onclick="openConv('${escapeHtml(c.id)}')">
          <div class="conv-avatar">
            ${escapeHtml((c.contact_name || '?').charAt(0).toUpperCase())}
            <div class="conv-platform">${PLATFORM_ICONS[c.platform] || 'üí¨'}</div>
          </div>
          <div class="conv-info">
            <div class="conv-name">
              <span>${escapeHtml(c.contact_name || c.contact_handle || 'Bilinmeyen')}</span>
              <span class="conv-time">${timeAgo(c.last_message_at)}</span>
            </div>
            <div class="conv-preview">
              <span>${escapeHtml(c.last_message || 'Mesaj yok')}</span>
              ${c.unread_count > 0 ? '<span class="unread-dot"></span>' : ''}
            </div>
          </div>
        </div>`).join('')
    }

    window.openConv = async function (id) {
      activeConvId = id
      const conv = allConvs.find(c => c.id === id)
      if (!conv) return
      renderConvList(allConvs)
      const chat = document.getElementById('convChat')
      chat.innerHTML = `
        <div class="chat-header">
          <div class="chat-header-avatar">${(conv.contact_name || '?').charAt(0).toUpperCase()}</div>
          <div>
            <div class="chat-header-name">${conv.contact_name || conv.contact_handle || 'Bilinmeyen'}</div>
            <div class="chat-header-sub">${PLATFORM_ICONS[conv.platform] || ''} ${conv.platform} ¬∑ ${conv.status}</div>
          </div>
          <div class="chat-header-actions">
            <button class="chat-action-btn">‚úì Kapat</button>
            <button class="chat-action-btn">üë§ Ki≈üiye Git</button>
          </div>
        </div>
        <div class="chat-messages" id="chatMsgs"><div style="text-align:center;color:var(--gray);font-size:0.8rem;padding:20px;">Y√ºkleniyor...</div></div>
        <div class="chat-input-wrap">
          <div class="chat-input-row">
            <textarea class="chat-textarea" id="msgInput" placeholder="Mesaj yaz..." rows="1"></textarea>
            <button class="chat-send-btn" onclick="sendMsg('${id}')">G√∂nder ‚Üí</button>
          </div>
        </div>`

      const { data: msgs } = await window._supabase.from('messages').select('*').eq('conversation_id', id).order('created_at', { ascending: true }).limit(100)
      const msgsEl = document.getElementById('chatMsgs')
      if (!msgs?.length) {
        msgsEl.innerHTML = '<div style="text-align:center;color:var(--gray);font-size:0.8rem;padding:20px;">Hen√ºz mesaj yok</div>'
        return
      }
      msgsEl.innerHTML = msgs.map(m => `
        <div>
          ${m.is_ai ? '<div class="msg-ai-tag">ü§ñ AI Yanƒ±tƒ±</div>' : ''}
          <div class="msg-bubble ${m.direction === 'outbound' ? 'outbound' : 'inbound'}${m.is_ai ? ' ai' : ''}">${escapeHtml(m.content)}</div>
          <div class="msg-meta" style="text-align:${m.direction === 'outbound' ? 'right' : 'left'}">${new Date(m.created_at).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}</div>
        </div>`).join('')
      msgsEl.scrollTop = msgsEl.scrollHeight

      // Realtime mesajlarƒ± dinle
      const { data: { session: convSess } } = await window._supabase.auth.getSession()
      subscribeToConv(id, convSess?.user.id)
    }

    window.sendMsg = async function (convId) {
      const input = document.getElementById('msgInput')
      if (!input) return
      const content = input.value.trim()
      if (!content) return
      input.value = ''
      input.style.height = 'auto'
      try {
        const { data: { session } } = await window._supabase.auth.getSession()
        if (!session) return

        // √ñnce Edge Function ile Meta'ya mesajƒ± g√∂nder!
        const { data: fnData, error: fnErr } = await window._supabase.functions.invoke('send-message', {
          body: { conv_id: convId, content }
        })

        if (fnErr || fnData?.error) {
          console.error("Meta G√∂nderim Hatasƒ±:", fnErr || fnData?.error)
          alert("Hata: Mesaj Facebook'a g√∂nderilemedi. (" + (fnData?.error || fnErr?.message) + ")")
          return // Geri d√∂n, DB'ye ekleme.
        }

        // G√∂nderim ba≈üarƒ±lƒ± ise veritabanƒ±na ekle
        await window._supabase.from('messages').insert({
          conversation_id: convId,
          user_id: session.user.id,
          direction: 'outbound',
          sender: 'human_agent',
          content,
          is_ai: false
        })
        await window._supabase.from('conversations').update({
          last_message: content,
          last_message_at: new Date().toISOString()
        }).eq('id', convId)

        appendMessage({ content, direction: 'outbound', is_ai: false, created_at: new Date().toISOString() })
      } catch (err) {
        console.error('Mesaj g√∂nderilemedi:', err)
        alert('Kritik Hata: ' + err.message)
      }
    }

    // ‚îÄ‚îÄ Mesajƒ± ekrana append et (sayfa yenilemeden) ‚îÄ‚îÄ
    function appendMessage(msg) {
      const msgsEl = document.getElementById('chatMsgs')
      if (!msgsEl) return
      // "Hen√ºz mesaj yok" yazƒ±sƒ±nƒ± kaldƒ±r
      if (msgsEl.querySelector('[data-empty]')) msgsEl.innerHTML = ''
      const div = document.createElement('div')
      div.innerHTML = `
        ${msg.is_ai ? '<div class="msg-ai-tag">ü§ñ AI Yanƒ±tƒ±</div>' : ''}
        <div class="msg-bubble ${msg.direction === 'outbound' ? 'outbound' : 'inbound'}${msg.is_ai ? ' ai' : ''}">${escapeHtml(msg.content)}</div>
        <div class="msg-meta" style="text-align:${msg.direction === 'outbound' ? 'right' : 'left'}">${new Date(msg.created_at).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}</div>
      `
      msgsEl.appendChild(div)
      msgsEl.scrollTop = msgsEl.scrollHeight
    }

    // ‚îÄ‚îÄ Realtime: A√ßƒ±k konu≈ümaya gelen mesajlarƒ± dinle ‚îÄ‚îÄ
    let realtimeChannel = null
    function subscribeToConv(convId, userId) {
      if (realtimeChannel) window._supabase.removeChannel(realtimeChannel)
      realtimeChannel = window._supabase
        .channel(`conv-messages-${convId}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'messages',
          filter: `conversation_id=eq.${convId}`,
        }, (payload) => {
          // Kendi g√∂nderdiƒüimiz mesajƒ± tekrar ekleme
          if (payload.new.direction === 'inbound' || payload.new.is_ai) {
            appendMessage(payload.new)
          }
        })
        .subscribe()
    }

    window.filterConvs = function (status, btn) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'))
      btn.classList.add('active')
      renderConvList(status === 'all' ? allConvs : allConvs.filter(c => c.status === status))
    }

    document.getElementById('searchInput').addEventListener('input', function () {
      const q = this.value.toLowerCase()
      renderConvList(allConvs.filter(c => (c.contact_name || '').toLowerCase().includes(q) || (c.last_message || '').toLowerCase().includes(q)))
    })

    function timeAgo(dateStr) {
      if (!dateStr) return ''
      const diff = Date.now() - new Date(dateStr)
      const m = Math.floor(diff / 60000)
      if (m < 1) return '≈üimdi'
      if (m < 60) return `${m}dk`
      const h = Math.floor(m / 60)
      if (h < 24) return `${h}sa`
      return `${Math.floor(h / 24)}g`
    }

    document.getElementById('logoutBtn').addEventListener('click', async e => {
      e.preventDefault(); e.stopPropagation()
      await window._supabase.auth.signOut()
      window.location.href = 'giris.html'
    })
  </script>
  <script type="module" src="mobile-nav.js"></script>
  <script src="sw-register.js"></script>
</body>

</html>