<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="description" content="DMAsistan Kurulum SihirbazÄ±" />
  <title>BaÅŸlayalÄ±m â€” DMAsistan</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet" />
  <style>
    :root {
      --bg: #0A0E1A;
      --bg-2: #0F1428;
      --purple: #7C3AED;
      --purple-light: #9B5CF6;
      --pink: #F43F75;
      --white: #FFFFFF;
      --gray: #A1A1AA;
      --glass: rgba(255, 255, 255, 0.04);
      --glass-border: rgba(255, 255, 255, 0.08);
      --gradient: linear-gradient(135deg, #7C3AED, #F43F75);
      --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--white);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow-x: hidden;
    }

    h1,
    h2,
    h3 {
      font-family: 'Sora', sans-serif;
    }

    .blob {
      position: fixed;
      border-radius: 50%;
      filter: blur(140px);
      opacity: 0.1;
      pointer-events: none;
      z-index: 0;
    }

    .blob-1 {
      width: 600px;
      height: 600px;
      background: var(--purple);
      top: -200px;
      left: -100px;
    }

    .blob-2 {
      width: 400px;
      height: 400px;
      background: var(--pink);
      bottom: -100px;
      right: -50px;
    }

    .onboarding-card {
      width: 100%;
      max-width: 600px;
      position: relative;
      z-index: 1;
      background: var(--bg-2);
      border: 1px solid var(--glass-border);
      border-radius: 28px;
      padding: 48px;
      box-shadow: 0 40px 80px rgba(0, 0, 0, 0.4);
      animation: fadeUp 0.5s ease both;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* PROGRESS */
    .progress-header {
      margin-bottom: 40px;
    }

    .progress-bar-wrap {
      height: 4px;
      background: var(--glass-border);
      border-radius: 2px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--gradient);
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.77rem;
      color: var(--gray);
    }

    .progress-label .current {
      color: var(--purple-light);
      font-weight: 600;
    }

    /* STEPS */
    .step {
      display: none;
      animation: fadeUp 0.4s ease both;
    }

    .step.active {
      display: block;
    }

    .step-icon {
      font-size: 3rem;
      text-align: center;
      margin-bottom: 16px;
    }

    .step-title {
      font-family: 'Sora', sans-serif;
      font-size: 1.6rem;
      font-weight: 800;
      text-align: center;
      margin-bottom: 8px;
    }

    .step-desc {
      font-size: 0.9rem;
      color: var(--gray);
      text-align: center;
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .gradient-text {
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* FORM */
    .form-row {
      margin-bottom: 18px;
    }

    .form-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 8px;
      display: block;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 13px 16px;
      color: var(--white);
      font-size: 0.9rem;
      font-family: 'Inter', sans-serif;
      outline: none;
      transition: var(--transition);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--purple);
      background: rgba(124, 58, 237, 0.06);
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: rgba(255, 255, 255, 0.25);
    }

    .form-select {
      appearance: none;
      cursor: pointer;
    }

    .form-select option {
      background: var(--bg-2);
    }

    .form-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .form-textarea {
      height: 100px;
      resize: vertical;
    }

    /* PLATFORM CARDS */
    .platform-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
    }

    .platform-option {
      background: var(--glass);
      border: 2px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      text-align: center;
      transition: var(--transition);
      position: relative;
    }

    .platform-option:hover {
      border-color: rgba(124, 58, 237, 0.4);
      background: rgba(124, 58, 237, 0.06);
    }

    .platform-option.selected {
      border-color: var(--purple);
      background: rgba(124, 58, 237, 0.12);
    }

    .platform-option.selected::after {
      content: 'âœ“';
      position: absolute;
      top: 10px;
      right: 12px;
      width: 20px;
      height: 20px;
      background: var(--purple);
      border-radius: 50%;
      font-size: 0.7rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .platform-option.soon {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .platform-emoji {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .platform-name {
      font-size: 0.87rem;
      font-weight: 600;
    }

    .platform-soon-label {
      font-size: 0.65rem;
      color: var(--gray);
      margin-top: 3px;
    }

    /* AI TONE */
    .tone-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tone-option {
      background: var(--glass);
      border: 2px solid var(--glass-border);
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .tone-option:hover,
    .tone-option.selected {
      border-color: var(--purple);
      background: rgba(124, 58, 237, 0.1);
    }

    .tone-label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .tone-desc {
      font-size: 0.72rem;
      color: var(--gray);
    }

    /* BUTTONS */
    .btn-next {
      width: 100%;
      padding: 15px;
      background: var(--gradient);
      border: none;
      border-radius: 14px;
      color: white;
      font-family: 'Sora', sans-serif;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 8px;
    }

    .btn-next:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 28px rgba(124, 58, 237, 0.4);
    }

    .btn-next:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-skip {
      width: 100%;
      padding: 12px;
      background: none;
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      color: var(--gray);
      font-size: 0.87rem;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 8px;
    }

    .btn-skip:hover {
      color: var(--white);
      border-color: rgba(255, 255, 255, 0.2);
    }

    /* SUCCESS */
    .success-confetti {
      text-align: center;
      padding: 20px 0;
    }

    .success-emoji {
      font-size: 4rem;
      animation: bounce 0.6s ease infinite alternate;
    }

    @keyframes bounce {
      from {
        transform: scale(1);
      }

      to {
        transform: scale(1.1);
      }
    }

    /* SPINNER */
    .spinner {
      display: none;
      width: 22px;
      height: 22px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading .btn-text {
      display: none;
    }

    .loading .spinner {
      display: block;
    }
  </style>
</head>

<body>
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>

  <div class="onboarding-card">
    <!-- PROGRESS -->
    <div class="progress-header">
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill" id="progressBar" style="width:25%"></div>
      </div>
      <div class="progress-label">
        <span class="current" id="stepLabel">AdÄ±m 1 / 4</span>
        <span id="stepName">Profil Bilgileri</span>
      </div>
    </div>

    <!-- STEP 1: Profil -->
    <div class="step active" id="step1">
      <div class="step-icon">ğŸ‘¤</div>
      <h2 class="step-title">Seni tanÄ±yalÄ±m, <span class="gradient-text" id="welcomeFirstName">hoÅŸ geldin</span>!</h2>
      <p class="step-desc">Ä°ÅŸletme bilgilerini girerek baÅŸlayalÄ±m</p>
      <div class="form-2">
        <div class="form-row">
          <label class="form-label">Ad</label>
          <input class="form-input" type="text" id="ob_firstName" placeholder="AdÄ±n" />
        </div>
        <div class="form-row">
          <label class="form-label">Soyad</label>
          <input class="form-input" type="text" id="ob_lastName" placeholder="SoyadÄ±n" />
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Ä°ÅŸletme / Marka AdÄ±</label>
        <input class="form-input" type="text" id="ob_business" placeholder="Ã–rn: AyÅŸe'nin Butik, TechStore..." />
      </div>
      <div class="form-2">
        <div class="form-row">
          <label class="form-label">SektÃ¶r</label>
          <select class="form-select" id="ob_industry">
            <option>E-ticaret</option>
            <option>Moda & Giyim</option>
            <option>GÃ¼zellik & BakÄ±m</option>
            <option>Yiyecek & Ä°Ã§ecek</option>
            <option>Hizmet SektÃ¶rÃ¼</option>
            <option>Teknoloji</option>
            <option>EÄŸitim</option>
            <option>SaÄŸlÄ±k</option>
            <option>DiÄŸer</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Telefon</label>
          <input class="form-input" type="tel" id="ob_phone" placeholder="+90 5xx..." />
        </div>
      </div>
      <button class="btn-next" onclick="goStep(2)">Devam Et â†’</button>
    </div>

    <!-- STEP 2: Platform -->
    <div class="step" id="step2">
      <div class="step-icon">ğŸ“±</div>
      <h2 class="step-title">Hangi platform<span class="gradient-text">larda</span> aktifsin?</h2>
      <p class="step-desc">Mesaj aldÄ±ÄŸÄ±n platformlarÄ± seÃ§. Daha sonra dilediÄŸin zaman ekleyebilirsin.</p>
      <div class="platform-grid">
        <div class="platform-option" data-platform="instagram" onclick="togglePlatform(this)">
          <div class="platform-emoji">ğŸ“¸</div>
          <div class="platform-name">Instagram</div>
        </div>
        <div class="platform-option" data-platform="whatsapp" onclick="togglePlatform(this)">
          <div class="platform-emoji">ğŸ’¬</div>
          <div class="platform-name">WhatsApp</div>
        </div>
        <div class="platform-option" data-platform="facebook" onclick="togglePlatform(this)">
          <div class="platform-emoji">ğŸ‘</div>
          <div class="platform-name">Facebook</div>
        </div>
        <div class="platform-option soon">
          <div class="platform-emoji">ğŸµ</div>
          <div class="platform-name">TikTok</div>
          <div class="platform-soon-label">YakÄ±nda</div>
        </div>
      </div>
      <button class="btn-next" onclick="goStep(3)">Devam Et â†’</button>
      <button class="btn-skip" onclick="goStep(3)">Åimdi deÄŸil, atla</button>
    </div>

    <!-- STEP 3: AI AyarÄ± -->
    <div class="step" id="step3">
      <div class="step-icon">ğŸ¤–</div>
      <h2 class="step-title">AI AsistanÄ±nÄ± <span class="gradient-text">ayarla</span></h2>
      <p class="step-desc">Yapay zekanÄ±n nasÄ±l konuÅŸmasÄ±nÄ± istiyorsun?</p>
      <div class="form-row">
        <label class="form-label">Bot AdÄ±</label>
        <input class="form-input" type="text" id="ob_botName" placeholder="Ã–rn: Asistan, YardÄ±mcÄ±, SatÄ±ÅŸ UzmanÄ±..."
          value="DMAsistan" />
      </div>
      <div class="form-row">
        <label class="form-label">KonuÅŸma Tonu</label>
        <div class="tone-grid">
          <div class="tone-option selected" data-tone="Samimi ve SÄ±cak" onclick="selectTone(this)">
            <div class="tone-label">ğŸ˜Š Samimi & SÄ±cak</div>
            <div class="tone-desc">ArkadaÅŸÃ§a, doÄŸal konuÅŸma</div>
          </div>
          <div class="tone-option" data-tone="Profesyonel ve Resmi" onclick="selectTone(this)">
            <div class="tone-label">ğŸ‘” Profesyonel</div>
            <div class="tone-desc">Resmi ve gÃ¼venilir</div>
          </div>
          <div class="tone-option" data-tone="NeÅŸeli ve EÄŸlenceli" onclick="selectTone(this)">
            <div class="tone-label">ğŸ‰ NeÅŸeli</div>
            <div class="tone-desc">Enerjik ve eÄŸlenceli</div>
          </div>
          <div class="tone-option" data-tone="KÄ±sa ve Net" onclick="selectTone(this)">
            <div class="tone-label">âš¡ KÄ±sa & Net</div>
            <div class="tone-desc">DoÄŸrudan, hÄ±zlÄ± yanÄ±t</div>
          </div>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Kendinden KÄ±saca Bahset (AI'ya Ã¶ÄŸret)</label>
        <textarea class="form-textarea" id="ob_prompt"
          placeholder="Ã–rn: KadÄ±n giyim butik sahibiyim. ÃœrÃ¼nlerim 200-800â‚º arasÄ±nda deÄŸiÅŸiyor. Kargo Ã¼cretsiz. Ä°ade garantisi var..."></textarea>
      </div>
      <button class="btn-next" onclick="goStep(4)">Devam Et â†’</button>
    </div>

    <!-- STEP 4: TamamlandÄ± -->
    <div class="step" id="step4">
      <div class="success-confetti">
        <div class="success-emoji">ğŸ‰</div>
      </div>
      <h2 class="step-title" style="margin-top:16px">Harika! Her ÅŸey <span class="gradient-text">hazÄ±r</span>!</h2>
      <p class="step-desc">DMAsistan hesabÄ±n kuruldu. ArtÄ±k otomatik satÄ±ÅŸlara baÅŸlayabilirsin.</p>
      <div
        style="background:rgba(124,58,237,0.08);border:1px solid rgba(124,58,237,0.2);border-radius:16px;padding:20px;margin-bottom:24px;">
        <div style="font-family:'Sora',sans-serif;font-weight:700;margin-bottom:12px;">âœ… Tamamlananlar</div>
        <div id="completedList" style="display:flex;flex-direction:column;gap:8px;font-size:0.85rem;"></div>
      </div>
      <button class="btn-next" id="dashboardBtn" onclick="finishOnboarding()">
        <span class="btn-text">ğŸš€ Dashboard'a Git</span>
        <div class="spinner"></div>
      </button>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js'

    // Auth kontrolÃ¼
    const { data: { session } } = await supabase.auth.getSession()
    if (!session) { window.location.replace('giris.html') }

    window.__user = session?.user
    const name = session?.user?.user_metadata?.full_name || ''
    const firstName = name.split(' ')[0]
    if (firstName) {
      document.getElementById('welcomeFirstName').textContent = firstName + '!'
      document.getElementById('ob_firstName').value = name.split(' ')[0] || ''
      document.getElementById('ob_lastName').value = name.split(' ').slice(1).join(' ') || ''
    }

    window.finishOnboarding = async function () {
      const btn = document.getElementById('dashboardBtn')
      btn.classList.add('loading')
      btn.disabled = true

      try {
        const user = window.__user
        if (!user) { window.location.replace('giris.html'); return }

        const firstName = document.getElementById('ob_firstName')?.value?.trim() || ''
        const lastName = document.getElementById('ob_lastName')?.value?.trim() || ''
        const business = document.getElementById('ob_business')?.value?.trim() || ''
        const industry = document.getElementById('ob_industry')?.value || 'E-ticaret'
        const phone = document.getElementById('ob_phone')?.value?.trim() || ''
        const botName = document.getElementById('ob_botName')?.value?.trim() || 'DMAsistan'
        const prompt = document.getElementById('ob_prompt')?.value?.trim() || ''
        const tone = document.querySelector('.tone-option.selected')?.dataset.tone || 'Samimi ve SÄ±cak'

        // Profili kaydet (upsert â€” zaten varsa gÃ¼ncelle)
        const { error: profileErr } = await supabase
          .from('profiles')
          .upsert({
            id: user.id,
            full_name: `${firstName} ${lastName}`.trim(),
            business_name: business,
            industry,
            phone,
            onboarding_completed: true,
            updated_at: new Date().toISOString()
          }, { onConflict: 'id' })
        if (profileErr) throw profileErr

        // AI ayarlarÄ±nÄ± kaydet (upsert)
        const { error: aiErr } = await supabase
          .from('ai_settings')
          .upsert({
            user_id: user.id,
            bot_name: botName,
            tone,
            system_prompt: prompt,
            updated_at: new Date().toISOString()
          }, { onConflict: 'user_id' })
        if (aiErr) throw aiErr

        // Onboarding adÄ±mlarÄ±nÄ± tamamla (upsert â€” 409'u Ã¶nler)
        const steps = ['profile', 'ai_setup', 'complete']
        for (const step of steps) {
          const { error: stepErr } = await supabase
            .from('onboarding_steps')
            .upsert({
              user_id: user.id,
              step,
              completed: true,
              completed_at: new Date().toISOString()
            }, { onConflict: 'user_id,step' })
          if (stepErr) throw stepErr
        }

        window.location.href = 'dashboard.html'
      } catch (err) {
        console.error('Onboarding kayÄ±t hatasÄ±:', err)
        btn.classList.remove('loading')
        btn.disabled = false
        // KullanÄ±cÄ±ya hata mesajÄ± gÃ¶ster
        const errDiv = document.getElementById('ob_error') || (() => {
          const d = document.createElement('div')
          d.id = 'ob_error'
          d.style.cssText = 'margin-top:12px;padding:12px 16px;background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.3);border-radius:10px;color:#f43f5e;font-size:0.85rem;text-align:center;'
          document.getElementById('dashboardBtn').after(d)
          return d
        })()
        errDiv.textContent = 'âš ï¸ Bir hata oluÅŸtu: ' + (err?.message || 'LÃ¼tfen tekrar deneyin.')
        errDiv.style.display = 'block'
      }
    }
  </script>

  <script>
    let currentStep = 1
    const totalSteps = 4
    const selectedPlatforms = new Set()
    const completedItems = []

    const stepNames = ['Profil Bilgileri', 'Platform SeÃ§imi', 'AI AyarÄ±', 'TamamlandÄ±!']
    const stepProgress = [25, 50, 75, 100]

    function showStepError(msg) {
      let el = document.getElementById('step1_error')
      if (!el) {
        el = document.createElement('div')
        el.id = 'step1_error'
        el.style.cssText = 'margin-bottom:12px;padding:12px 16px;background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.3);border-radius:10px;color:#f43f5e;font-size:0.85rem;text-align:center;'
        document.getElementById('step1').insertBefore(el, document.querySelector('.btn-next'))
      }
      el.textContent = 'âš ï¸ ' + msg
      el.style.display = 'block'
      el.scrollIntoView({ behavior: 'smooth', block: 'nearest' })
    }

    function goStep(step) {
      // Step 1 validasyonu
      if (currentStep === 1 && step === 2) {
        const fn = document.getElementById('ob_firstName').value.trim()
        const ln = document.getElementById('ob_lastName').value.trim()
        const bn = document.getElementById('ob_business').value.trim()
        if (!fn) { showStepError('Ad alanÄ± zorunludur.'); return }
        if (!ln) { showStepError('Soyad alanÄ± zorunludur.'); return }
        if (!bn) { showStepError('Ä°ÅŸletme / Marka AdÄ± zorunludur.'); return }
        const errEl = document.getElementById('step1_error')
        if (errEl) errEl.style.display = 'none'
      }
      // Mevcut adÄ±mÄ± kaydet
      if (currentStep === 1) {
        const fn = document.getElementById('ob_firstName').value.trim()
        const bn = document.getElementById('ob_business').value.trim()
        if (fn) completedItems.push(`ğŸ‘¤ ${fn} olarak kaydedildin`)
        if (bn) completedItems.push(`ğŸ¢ Ä°ÅŸletme: ${bn}`)
      }
      if (currentStep === 2) {
        if (selectedPlatforms.size > 0) {
          completedItems.push(`ğŸ“± ${selectedPlatforms.size} platform seÃ§ildi`)
        }
      }
      if (currentStep === 3) {
        const tone = document.querySelector('.tone-option.selected')?.querySelector('.tone-label')?.textContent
        if (tone) completedItems.push(`ğŸ¤– AI tonu: ${tone}`)
      }

      document.getElementById(`step${currentStep}`).classList.remove('active')
      currentStep = step
      document.getElementById(`step${currentStep}`).classList.add('active')

      document.getElementById('progressBar').style.width = stepProgress[step - 1] + '%'
      document.getElementById('stepLabel').textContent = `AdÄ±m ${step} / ${totalSteps}`
      document.getElementById('stepName').textContent = stepNames[step - 1]

      // Son adÄ±mda tamamlananlarÄ± gÃ¶ster
      if (step === 4) {
        function escHtml(s) { return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') }
        const list = document.getElementById('completedList')
        list.innerHTML = completedItems.map(item =>
          `<div style="display:flex;align-items:center;gap:8px;"><span style="color:#22c55e">âœ“</span> ${escHtml(item)}</div>`
        ).join('')
      }

      window.scrollTo({ top: 0, behavior: 'smooth' })
    }

    function togglePlatform(el) {
      if (el.classList.contains('soon')) return
      const platform = el.dataset.platform
      el.classList.toggle('selected')
      if (el.classList.contains('selected')) {
        selectedPlatforms.add(platform)
      } else {
        selectedPlatforms.delete(platform)
      }
    }

    function selectTone(el) {
      document.querySelectorAll('.tone-option').forEach(o => o.classList.remove('selected'))
      el.classList.add('selected')
    }
  </script>
  <script src="sw-register.js"></script>
</body>

</html>